meta {
  name: Test Webhook - Charge Success
  type: http
  seq: 8
}

post {
  url: {{BASE_URL}}/api/v1/billing/paystack/webhook
  body: json
  auth: none
}

headers {
  x-paystack-signature: {{WEBHOOK_SIGNATURE}}
}

body:json {
  {
    "event": "charge.success",
    "data": {
      "reference": "test_ref_{{$timestamp}}",
      "amount": 9900,
      "currency": "ZAR",
      "status": "success",
      "paid_at": "{{$isoTimestamp}}",
      "customer": {
        "email": "test@example.com",
        "customer_code": "CUS_test123"
      },
      "authorization": {
        "authorization_code": "AUTH_test123",
        "card_type": "visa",
        "last4": "4081"
      },
      "metadata": {
        "subscriptionCode": "SUB_test123",
        "customerCode": "CUS_test123",
        "currency": "ZAR"
      },
      "subscription": {
        "subscription_code": "SUB_test123"
      }
    }
  }
}

script:pre-request {
  const crypto = require('crypto');
  const body = req.getBody();
  const secret = bru.getEnvVar('PAYSTACK_SECRET_KEY');
  
  // Convert body to string (Paystack signs the raw JSON string)
  const bodyString = typeof body === 'string' ? body : JSON.stringify(body);
  
  // Generate HMAC SHA512 signature
  const signature = crypto
    .createHmac('sha512', secret)
    .update(bodyString)
    .digest('hex');
  
  bru.setVar('WEBHOOK_SIGNATURE', signature);
  
  console.log('Generated signature:', signature);
  console.log('Body length:', bodyString.length);
}

docs {
  # Test Webhook - Charge Success
  
  Simulates a successful payment webhook from Paystack.
  
  ## What it tests
  - Webhook signature verification
  - Payment success handling
  - Subscription activation (if PENDING)
  - Subscription period extension (if ACTIVE)
  - Transaction record creation
  
  ## Prerequisites
  - Have a PENDING subscription with matching reference in database
  - OR have an ACTIVE subscription with matching subscription code
  
  ## Expected Response
  ```json
  {
    "success": true
  }
  ```
  
  ## Notes
  - Signature is auto-generated in pre-request script
  - Uses test data that won't affect real subscriptions
  - Check server logs to see webhook processing
}
