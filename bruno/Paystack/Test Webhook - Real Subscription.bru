meta {
  name: Test Webhook - Real Subscription
  type: http
  seq: 11
}

post {
  url: {{BASE_URL}}/api/v1/billing/paystack/webhook
  body: json
  auth: none
}

headers {
  x-paystack-signature: {{WEBHOOK_SIGNATURE}}
}

body:json {
  {
    "event": "charge.success",
    "data": {
      "reference": "sub_user_291535c6_1765288057830",
      "amount": 9900,
      "currency": "ZAR",
      "status": "success",
      "paid_at": "{{$isoTimestamp}}",
      "customer": {
        "email": "test@example.com",
        "customer_code": "CUS_uswsrj8nhwav1cc"
      },
      "authorization": {
        "authorization_code": "AUTH_test123",
        "card_type": "visa",
        "last4": "4081",
        "reusable": true
      },
      "metadata": {
        "subscriptionCode": "SUB_x5tzkqwt3qnxzw8",
        "customerCode": "CUS_uswsrj8nhwav1cc",
        "currency": "ZAR"
      },
      "subscription": {
        "subscription_code": "SUB_x5tzkqwt3qnxzw8",
        "status": "active"
      }
    }
  }
}

script:pre-request {
  const crypto = require('crypto');
  const body = req.getBody();
  const secret = bru.getEnvVar('PAYSTACK_SECRET_KEY');
  
  // Convert body to string (Paystack signs the raw JSON string)
  const bodyString = typeof body === 'string' ? body : JSON.stringify(body);
  
  // Generate HMAC SHA512 signature
  const signature = crypto
    .createHmac('sha512', secret)
    .update(bodyString)
    .digest('hex');
  
  bru.setVar('WEBHOOK_SIGNATURE', signature);
  
  console.log('Generated signature:', signature);
  console.log('Body length:', bodyString.length);
}

docs {
  # Test Webhook - Real Subscription
  
  Tests webhook with your actual subscription data from the database.
  
  ## Subscription Details
  - **ID**: 6
  - **Reference**: sub_user_291535c6_1765288057830
  - **Customer Code**: CUS_uswsrj8nhwav1cc
  - **Subscription Code**: SUB_x5tzkqwt3qnxzw8
  - **Status**: ACTIVE
  - **Amount**: R99.00
  - **Period**: 2025-12-09 to 2026-01-09
  - **Cancel at Period End**: true
  
  ## What it tests
  - Recurring payment for active subscription
  - Period extension (should extend to 2026-02-09)
  - Cancellation flag reset (should set cancelAtPeriodEnd to false)
  - Transaction record creation
  
  ## Expected Behavior
  Since the subscription has `cancelAtPeriodEnd = true`, a successful payment should:
  1. Extend the billing period by 1 month
  2. Reset `cancelAtPeriodEnd` to `false` (user re-enabled)
  3. Create a PAYMENT_COMPLETE transaction record
  
  ## Expected Response
  ```json
  {
    "success": true
  }
  ```
  
  ## Notes
  - Uses your real subscription data
  - Signature is auto-generated
  - Check server logs to see:
    - "Subscription period extended: 6"
    - "Subscription re-enabled, cancellation flag reset: 6"
}