meta {
  name: Test Webhook - Subscription Disable
  type: http
  seq: 9
}

post {
  url: {{BASE_URL}}/api/v1/billing/paystack/webhook
  body: json
  auth: none
}

headers {
  x-paystack-signature: {{WEBHOOK_SIGNATURE}}
}

body:json {
  {
    "event": "subscription.disable",
    "data": {
      "subscription": {
        "subscription_code": "SUB_test123",
        "status": "cancelled"
      },
      "customer": {
        "email": "test@example.com",
        "customer_code": "CUS_test123"
      }
    }
  }
}

script:pre-request {
  const crypto = require('crypto');
  const body = req.getBody();
  const secret = bru.getEnvVar('PAYSTACK_SECRET_KEY');
  
  // Convert body to string (Paystack signs the raw JSON string)
  const bodyString = typeof body === 'string' ? body : JSON.stringify(body);
  
  // Generate HMAC SHA512 signature
  const signature = crypto
    .createHmac('sha512', secret)
    .update(bodyString)
    .digest('hex');
  
  bru.setVar('WEBHOOK_SIGNATURE', signature);
  
  console.log('Generated signature:', signature);
  console.log('Body length:', bodyString.length);
}

docs {
  # Test Webhook - Subscription Disable
  
  Simulates a subscription cancellation webhook from Paystack.
  
  ## What it tests
  - Webhook signature verification
  - Subscription cancellation handling
  - Cancel at period end logic (if valid period exists)
  - Immediate cancellation (if no valid period)
  - Transaction record creation
  
  ## Prerequisites
  - Have an ACTIVE subscription with matching subscription code
  
  ## Expected Response
  ```json
  {
    "success": true
  }
  ```
  
  ## Behavior
  - If subscription has valid period end: Sets `cancelAtPeriodEnd = true`
  - If no valid period end: Sets status to CANCELLED immediately
  
  ## Notes
  - Signature is auto-generated in pre-request script
  - Check server logs to see cancellation logic
}