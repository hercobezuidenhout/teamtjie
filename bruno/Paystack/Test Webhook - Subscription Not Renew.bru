meta {
  name: Test Webhook - Subscription Not Renew
  type: http
  seq: 12
}

post {
  url: {{BASE_URL}}/api/v1/billing/paystack/webhook
  body: json
  auth: none
}

headers {
  x-paystack-signature: {{WEBHOOK_SIGNATURE}}
}

body:json {
  {
    "event": "subscription.not_renew",
    "data": {
      "subscription": {
        "subscription_code": "SUB_x5tzkqwt3qnxzw8",
        "status": "non-renewing",
        "next_payment_date": "2026-01-09T00:00:00.000Z"
      },
      "customer": {
        "email": "test@example.com",
        "customer_code": "CUS_uswsrj8nhwav1cc"
      }
    }
  }
}

script:pre-request {
  const crypto = require('crypto');
  const body = req.getBody();
  const secret = bru.getEnvVar('PAYSTACK_SECRET_KEY');
  
  // Convert body to string (Paystack signs the raw JSON string)
  const bodyString = typeof body === 'string' ? body : JSON.stringify(body);
  
  // Generate HMAC SHA512 signature
  const signature = crypto
    .createHmac('sha512', secret)
    .update(bodyString)
    .digest('hex');
  
  bru.setVar('WEBHOOK_SIGNATURE', signature);
  
  console.log('Generated signature:', signature);
  console.log('Body length:', bodyString.length);
}

docs {
  # Test Webhook - Subscription Not Renew
  
  Simulates the event fired when a user cancels their subscription on Paystack.
  This is the FIRST event in the cancellation flow.
  
  ## What it tests
  - Webhook signature verification
  - Immediate cancellation handling
  - Sets `cancelAtPeriodEnd = true`
  - Keeps subscription ACTIVE until period end
  - Transaction record creation
  
  ## Prerequisites
  - Have an ACTIVE subscription with matching subscription code
  
  ## Expected Response
  ```json
  {
    "success": true
  }
  ```
  
  ## Expected Behavior
  - Sets `cancelAtPeriodEnd = true`
  - Status remains ACTIVE
  - Subscription continues until next_payment_date
  - Frontend shows "ENDING SOON" badge
  
  ## Real-World Flow
  1. User cancels on Paystack → `subscription.not_renew` fires (THIS EVENT)
  2. Subscription stays active until period end
  3. On period end → `subscription.disable` fires
  
  ## Notes
  - This is the event you should see when users cancel on Paystack management page
  - Use subscription code: SUB_x5tzkqwt3qnxzw8 (your real subscription)
}