// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum RoleType {
  ADMIN
  MEMBER
  GUEST
}

enum ScopeType {
  SPACE
  TEAM
}

enum PostType {
  WIN
}

enum ScopePostPermissionAction {
  post
  read
  view_author
}

enum NotificationType {
  EMAIL
  IN_APP
}

// Models

model User {
  id                      String                       @id @default(cuid())
  name                    String
  email                   String?                      @unique
  image                   String?
  aboutMe                 String?
  createdAt               DateTime                     @default(now())
  updatedAt               DateTime                     @default(now()) @updatedAt
  createdInvitations      Invitation[]
  roles                   ScopeRole[]
  postReactions           PostReaction[]
  issuedByPosts           Post[]                       @relation("Post_issuedToUser")
  issuedToPosts           Post[]                       @relation("Post_issuedByUser")
  acceptedInvites         AcceptedInvite[]
  notificationPreferences UserNotificationPreference[]
  dailySentiments         DailySentiment[]
  createdHealthChecks     HealthCheck[]
  healthCheckResponses    HealthCheckResponse[]
}

model DeactivateUser {
  id        String  @id @default(cuid())
  email     String? @unique
  processed Boolean @default(false)
}

model Scope {
  id                   Int                   @id @default(autoincrement())
  name                 String
  image                String?
  description          String?
  type                 ScopeType
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now()) @updatedAt
  parentScopeId        Int?
  isPublic             Boolean               @default(false)
  parentScope          Scope?                @relation(name: "parentScope", fields: [parentScopeId], references: [id], onDelete: Cascade)
  childScopes          Scope[]               @relation(name: "parentScope")
  roles                ScopeRole[]
  invitations          Invitation[]
  scopeValues          ScopeValue[]
  scopeLinks           ScopeLink[]
  posts                Post[]
  ScopePostPermission  ScopePostPermission[]
  resendDetails        ScopeResendDetails[]
  dailySentiments      DailySentiment[]
  settings             ScopeSettings?
  healthChecks         HealthCheck[]
}

model ScopeValue {
  id          Int         @id @default(autoincrement())
  name        String
  description String
  scopeId     Int
  scope       Scope       @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  PostValue   PostValue[]

  @@unique([scopeId, name])
}

model ScopeLink {
  id       Int     @id @default(autoincrement())
  title    String
  url      String
  scopeId  Int
  scope    Scope   @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  isPublic Boolean

  @@unique([scopeId, title])
  @@unique([scopeId, url])
}

model ScopeRole {
  role    RoleType @default(MEMBER)
  userId  String
  scopeId Int
  scope   Scope    @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([role, scopeId, userId])
  @@index([userId])   // Speed up user scope lookups
  @@index([scopeId])  // Speed up scope member lookups and counts
}

model Invitation {
  id              Int              @id @default(autoincrement())
  hash            String
  expiresAt       DateTime
  createdByUserId String
  user            User             @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  scopeId         Int
  scope           Scope            @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  defaultRole     RoleType         @default(MEMBER)
  acceptedInvites AcceptedInvite[]
}

model Post {
  id          Int            @id @default(autoincrement())
  issuedBy    User           @relation(name: "Post_issuedByUser", fields: [issuedById], references: [id], onDelete: Cascade)
  issuedById  String
  issuedTo    User?          @relation(name: "Post_issuedToUser", fields: [issuedToId], references: [id], onDelete: Cascade)
  issuedToId  String?
  description String
  reactions   PostReaction[]
  values      PostValue[]
  type        PostType
  scope       Scope          @relation(map: "Post_scopeId_scope_fk", fields: [scopeId], references: [id], onDelete: Cascade)
  scopeId     Int
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @default(now()) @updatedAt

  @@index([scopeId, createdAt(sort: Desc)])  // Speed up feed queries
  @@index([issuedById])                       // Speed up user post lookups
  @@index([issuedToId])                       // Speed up recipient lookups
}

model PostReaction {
  postId    Int
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reaction  String
  createdAt DateTime @default(now())

  @@id([postId, userId, reaction])
  @@index([postId])  // Speed up reaction lookups
}

model PostValue {
  scopeValueId Int
  scopeValue   ScopeValue @relation(fields: [scopeValueId], references: [id], onDelete: Cascade)
  postId       Int
  post         Post       @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([scopeValueId, postId])
}

model TeamtjieToken {
  id        String   @id @default(cuid())
  token     String
  createdAt DateTime @default(now())
}

model ScopePostPermission {
  id      Int                       @id @default(autoincrement())
  scopeId Int
  scope   Scope                     @relation(map: "ScopePostPermission_scopeId_scope_fk", fields: [scopeId], references: [id], onDelete: Cascade)
  action  ScopePostPermissionAction
  type    PostType
  roles   ScopePostPermissionRole[]
}

model ScopePostPermissionRole {
  scopePostPermissionId   Int
  scopePostPermissionRole ScopePostPermission @relation(map: "ScopePostPermissionRole_scopeId_scope_fk", fields: [scopePostPermissionId], references: [id], onDelete: Cascade)
  role                    RoleType

  @@id([scopePostPermissionId, role])
}

model AcceptedInvite {
  id        Int      @id @default(autoincrement())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  invitationId Int
  invitation   Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)
}

model UserNotificationPreference {
  userId  String
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type    NotificationType
  event   String
  enabled Boolean

  @@id([userId, type, event])
}

model ScopeResendDetails {
  id          Int    @id @default(autoincrement())
  scopeId     Int    @unique
  scope       Scope  @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  apiKey      String
  senderName  String
  senderEmail String
}

model DailySentiment {
  id        Int      @id @default(autoincrement())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  scopeId   Int
  scope     Scope    @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  sentiment Int
  note      String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scopeId, date])
  @@index([userId, scopeId, createdAt(sort: Desc)])
}

model ScopeSettings {
  id                   Int     @id @default(autoincrement())
  scopeId              Int     @unique
  scope                Scope   @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  showAverageSentiment Boolean @default(false)
}

model HealthCheck {
  id          Int                     @id @default(autoincrement())
  scopeId     Int
  scope       Scope                   @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  templateId  String
  createdAt   DateTime                @default(now())
  createdBy   String
  creator     User                    @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  questions   HealthCheckQuestion[]
  responses   HealthCheckResponse[]

  @@index([scopeId, createdAt(sort: Desc)])
}

model HealthCheckQuestion {
  id            Int                   @id @default(autoincrement())
  healthCheckId Int
  healthCheck   HealthCheck           @relation(fields: [healthCheckId], references: [id], onDelete: Cascade)
  title         String
  description   String                @db.Text
  order         Int
  answers       HealthCheckAnswer[]

  @@index([healthCheckId])
}

model HealthCheckResponse {
  id            Int                   @id @default(autoincrement())
  healthCheckId Int
  healthCheck   HealthCheck           @relation(fields: [healthCheckId], references: [id], onDelete: Cascade)
  userId        String
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  completedAt   DateTime?
  answers       HealthCheckAnswer[]

  @@unique([healthCheckId, userId])
  @@index([healthCheckId])
  @@index([userId])
}

model HealthCheckAnswer {
  id         Int                   @id @default(autoincrement())
  responseId Int
  response   HealthCheckResponse   @relation(fields: [responseId], references: [id], onDelete: Cascade)
  questionId Int
  question   HealthCheckQuestion   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  score      Int
  note       String?               @db.Text

  @@unique([responseId, questionId])
  @@index([questionId])
}
